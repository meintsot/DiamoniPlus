<p-card *ngIf="!loading; else loadingTemplate" class="d-flex justify-content-center" header="View Profile" [style]="{width: '40%'}">
  <!-- Avatar display -->
  <div class="text-center">
    <p-avatar *ngIf="!avatar"
              [label]="getInitials(profile)"
              styleClass="mr-2"
              size="xlarge"
              shape="circle">
    </p-avatar>
    <p-avatar *ngIf="avatar"
              [image]="avatar"
              styleClass="mr-2"
              size="xlarge"
              shape="circle">
    </p-avatar>
  </div>

  <hr/>

  <!-- Display profile information -->
  <div class="d-flex justify-content-center">
    <div>
      <div class="p-1" *ngFor="let field of profileFields">
        <strong>{{ field.label }}: </strong>
        <span>{{ getProfileValue(field.label) }}</span>
      </div>

      <button *ngIf="!isHostApproved && isAdmin && profile.desiredRole === 'host'"
              pButton class="btn-danger"
              (click)="approveHost()">
        Approve Host
      </button>
      <button *ngIf="isHostApproved && isAdmin && profile.desiredRole === 'host'"
              pButton class="btn-success"
              disabled>
        Host Approved
      </button>
      <button *ngIf="isTenant && profile.desiredRole === 'host'"
              pButton class="btn-danger"
              (click)="moveToDiscussions()">
        Discuss it
      </button>
    </div>
  </div>

  <ng-container *ngIf="profile.desiredRole === 'host'">
    <p-divider></p-divider>
    <p-fieldset legend="User Reviews">
      <ng-container *ngIf="!isAdmin && !hasSubmittedReview && isAuthenticated">
        <!-- Review submission form -->
        <div *ngIf="isAuthenticated && isTenant && !hasSubmittedReview">
          <form [formGroup]="reviewForm">
            <h3>Submit Your Review</h3>
            <div class="form-group">
              <label for="rating">Rating:</label>
              <!-- Use your custom rating component here -->
              <p-rating id="rating" formControlName="rating" [cancel]="false"></p-rating>
            </div>
            <div class="form-group">
              <label for="reviewText">Your Review:</label>
              <textarea id="reviewText" rows="3" class="form-control" pInputTextarea formControlName="description"></textarea>
            </div>
            <button pButton type="button" label="Submit Review" (click)="submitReview()"></button>
          </form>
        </div>

        <!-- Average Reviews -->
        <div class="mt-4">
          <h3>Average Rating</h3>
          <!-- Use your custom rating component here -->
          <app-star-rating [rating]="averageReviews"></app-star-rating>
          <p>{{averageReviews}} out of 5 stars</p>
        </div>

        <!-- Existing Reviews -->
        <div class="mt-4">
          <h3>Existing Reviews</h3>
          <div class="review mb-3" *ngFor="let review of reviews; let i = index">
            <div class="d-flex align-items-start">
              <!-- Avatar -->
              <div class="me-3">
                <p-avatar *ngIf="reviewImages[i] !== ''" [image]="reviewImages[i]" size="large" shape="circle"></p-avatar>
                <p-avatar *ngIf="reviewImages[i] === ''" [label]="review.author.substring(0, 1)" size="large" shape="circle"></p-avatar>
              </div>
              <!-- Review Content -->
              <div class="flex-grow-1">
                <p class="mb-1"><strong>{{review.author}}</strong></p>
                <p class="mb-1">{{review.description}}</p>
                <app-star-rating [rating]="review.rating"></app-star-rating>
              </div>
            </div>
            <hr>
          </div>
        </div>
        <p-paginator [rows]="page"
                     [first]="pageSize"
                     (onPageChange)="paginate($event)">
        </p-paginator>
      </ng-container>
    </p-fieldset>
  </ng-container>
</p-card>

<ng-template #loadingTemplate>
  <div class="p-d-flex p-jc-center p-ai-center p-flex-column">
    <!-- Avatar Skeleton -->
    <p-skeleton class="p-mb-2" width="75px" height="75px" borderRadius="50%"></p-skeleton>

    <!-- Profile Fields Skeletons -->
    <div *ngFor="let field of profileFields" class="p-mb-2">
      <p-skeleton width="200px" height="16px"></p-skeleton>
    </div>

    <!-- Conditional Buttons Skeletons (if needed) -->
    <p-skeleton width="200px" height="36px" class="p-mb-2"></p-skeleton>
    <p-skeleton width="200px" height="36px" class="p-mb-2"></p-skeleton>

    <!-- Average Reviews & Existing Reviews Skeletons (if needed) -->
    <p-skeleton width="100px" height="16px" class="p-mb-2"></p-skeleton>
    <p-skeleton width="300px" height="16px" class="p-mb-2"></p-skeleton>
  </div>
</ng-template>
